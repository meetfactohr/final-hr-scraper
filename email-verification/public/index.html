<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Intelligence | Business Verifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfdfd; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid #eef2f6; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-10">
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Email Intelligence Verifier</h1>
            <p class="text-slate-500 font-medium">Bulk SMTP Handshake & Catch-all Detection Engine.</p>
        </header>

        <div class="grid grid-cols-12 gap-8">
            <!-- Left: Controls -->
            <div class="col-span-4 space-y-6">
                <div class="glass p-6 rounded-[32px] shadow-sm">
                    <input type="file" id="csvFile" class="hidden" accept=".csv">
                    <div onclick="document.getElementById('csvFile').click()" class="border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center cursor-pointer hover:bg-slate-50 transition-all">
                        <i data-lucide="mail" class="w-10 h-10 mx-auto mb-4 text-slate-300"></i>
                        <p id="fileName" class="text-sm font-bold text-slate-500">Upload Emails CSV</p>
                    </div>
                    <button id="runBtn" onclick="startVerification()" class="w-full mt-4 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition-all">
                        Start Verification
                    </button>
                </div>

                <div id="logConsole" class="bg-slate-900 text-[11px] text-slate-400 p-4 h-64 rounded-2xl font-mono overflow-y-auto">
                    > System Online. Ready for list...
                </div>
            </div>

            <!-- Right: Results -->
            <div class="col-span-8">
                <div class="glass rounded-[32px] overflow-hidden min-h-[500px] flex flex-col">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="font-bold text-slate-800">Verification Results</h2>
                        <a id="dlBtn" href="#" class="hidden bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold">Download Results</a>
                    </div>
                    <div id="tableWrapper" class="flex-1 overflow-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="px-6 py-4">Email Address</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Score</th>
                                    <th class="px-6 py-4">Reason</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-sm divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const csvFile = document.getElementById('csvFile');
        const logConsole = document.getElementById('logConsole');
        const tableBody = document.getElementById('tableBody');
        const dlBtn = document.getElementById('dlBtn');

        const eventSource = new EventSource('/status');
        eventSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === 'progress') addLog(data.message);
            if(data.type === 'row_found') addRow(data.result);
            if(data.type === 'finish') {
                addLog("âœ… Job Complete!");
                dlBtn.href = data.downloadUrl;
                dlBtn.classList.remove('hidden');
                document.getElementById('runBtn').innerText = "Launch New Job";
            }
        };

        function addLog(m) {
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${m}`;
            logConsole.prepend(div);
        }

        function addRow(r) {
            const tr = document.createElement('tr');
            const color = r.score === 100 ? 'text-emerald-600' : (r.score === 70 ? 'text-blue-600' : 'text-red-600');
            tr.innerHTML = `
                <td class="px-6 py-4 font-semibold">${r.email}</td>
                <td class="px-6 py-4 font-bold ${color}">${r.status}</td>
                <td class="px-6 py-4 text-center font-mono">${r.score}%</td>
                <td class="px-6 py-4 text-slate-400 text-xs">${r.reason}</td>
            `;
            tableBody.prepend(tr);
        }

        async function startVerification() {
            if(!csvFile.files[0]) return alert("Select CSV!");
            const fd = new FormData();
            fd.append('csvfile', csvFile.files[0]);
            tableBody.innerHTML = '';
            document.getElementById('runBtn').innerText = "Verifying...";
            await fetch('/upload', { method: 'POST', body: fd });
        }

        csvFile.onchange = () => document.getElementById('fileName').innerText = csvFile.files[0].name;
    </script>
</body>
</html>